<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kampoeng Kelong</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary: #e63946;
      --bg: #f8f9fa;
      --text: #212529;
      --card-bg: #ffffff;
      --shadow: rgba(0,0,0,0.15);
    }

    [data-theme="dark"] {
      --bg: #212529;
      --text: #f8f9fa;
      --card-bg: #343a40;
      --shadow: rgba(255,255,255,0.1);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 60px; /* Space for bottom navbar */
      transition: background 0.3s, color 0.3s;
    }

    .main-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--primary);
      padding: 15px 0;
      box-shadow: 0 2px 5px var(--shadow);
    }

    .header-title {
      font-size: 1.5rem;
      margin: 0;
      font-weight: 700;
    }

    .btn-search {
        background: transparent;
        border: none;
    }

    .btn-search:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .product-card {
      background: var(--card-bg);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 15px;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px var(--shadow);
    }

    .product-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 10px var(--shadow);
    }

    .product-card img {
      height: 150px; /* Adjusted for 2-column layout on mobile */
      object-fit: cover;
      border-bottom: 1px solid var(--shadow);
    }

    .product-card .card-body {
      padding: 12px;
    }

    .product-card .card-title {
      font-size: 1rem; /* Adjusted for smaller card */
      font-weight: 600;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .product-card .card-text.text-danger {
        font-size: 0.9rem;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      box-shadow: 0 -2px 10px var(--shadow);
      z-index: 1000;
      padding: 10px 0;
    }

    .bottom-nav .nav-link {
      text-align: center;
      color: var(--text);
      font-size: 0.9rem;
      padding: 5px;
    }

    .bottom-nav .nav-link.active {
      color: var(--primary);
    }

    .pagination .page-link {
      color: var(--primary);
      border-radius: 10px;
    }

    .pagination .active .page-link {
      background: var(--primary);
      border-color: var(--primary);
    }

    footer {
      background: var(--card-bg);
      padding: 15px 0;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text);
    }
    
    .list-group-item.list-group-item-action:hover, .list-group-item.list-group-item-action:focus {
        background-color: var(--bg);
    }

    @media (min-width: 768px) {
      .product-card img {
        height: 220px;
      }
      .product-card .card-title {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <header class="main-header">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <button class="btn me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
          <i class="bi bi-list fs-4 text-white"></i>
        </button>
        <h1 class="header-title text-white">KAMPOENG KELONG</h1>
      </div>
      <a href="#" class="btn btn-search" data-bs-toggle="modal" data-bs-target="#searchModal">
          <i class="bi bi-search fs-5 text-white"></i>
      </a>
    </div>
  </header>

  <div class="container my-3">
    <div id="product-grid" class="row row-cols-2 row-cols-md-2 row-cols-lg-3 g-3">
      </div>
    <nav aria-label="Pagination" class="d-flex justify-content-center mt-4">
      <ul id="pagination" class="pagination">
        </ul>
    </nav>
  </div>

  <nav class="bottom-nav">
    <div class="container d-flex justify-content-around">
      <a href="#" class="nav-link active"><i class="bi bi-house fs-5"></i><br>Home</a>
      <a href="#" class="nav-link" id="category-btn" data-bs-toggle="modal" data-bs-target="#categoryModal"><i class="bi bi-tags fs-5"></i><br>Kategori</a>
      <a href="#" class="nav-link" id="cart-btn" data-bs-toggle="modal" data-bs-target="#cartModal"><i class="bi bi-cart fs-5"></i><br>Keranjang <span id="cart-badge" class="badge bg-danger rounded-pill" style="display: none;">0</span></a>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarMenuLabel">Navigasi</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item"><a href="index.html" class="text-decoration-none d-block"><i class="bi bi-house me-2"></i>Home</a></li>
        <li class="list-group-item"><a href="#" class="text-decoration-none d-block"><i class="bi bi-info-circle me-2"></i>Info Toko</a></li>
        <li class="list-group-item"><a href="#" class="text-decoration-none d-block"><i class="bi bi-gear me-2"></i>Pengaturan</a></li>
      </ul>
    </div>
  </div>

  <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: var(--card-bg); color: var(--text);">
        <div class="modal-header">
          <h5 class="modal-title" id="searchModalLabel">Cari Menu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input id="search-input-modal" class="form-control" type="search" placeholder="Cari menu..." aria-label="Search">
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: var(--card-bg); color: var(--text);">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel">Pilih Kategori</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="category-menu" class="list-group">
            </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: var(--card-bg); color: var(--text);">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Keranjang Belanja</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="cart-list" class="list-group mb-3"></ul>
          <p class="fw-bold">Total: Rp <span id="cart-total">0</span></p>
          <a id="checkout-btn" href="#" class="btn btn-success w-100"><i class="bi bi-whatsapp"></i> Checkout via WhatsApp</a>
        </div>
        <div class="modal-footer">
          <button id="clear-cart" type="button" class="btn btn-danger">Kosongkan Keranjang</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2025 waroksungo. Hubungi: <a href="https://wa.me/6283807602549?text=Halo,%20ada%20pertanyaan?" class="text-decoration-none">WhatsApp</a> Ikuti: <a href="https://x.com/kampoengkelongs" class="text-decoration-none">@kampoengkelong</a></p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycby9ouMAhiw_hqP4OY8l4uIjzxsB8l6qNu_YJ9Ww8HZfptcAVaGz8kH-NsSCtKPi3R5xdQ/exec';
    let allProducts = [];
    let filteredProducts = [];
    const itemsPerPage = 6;
    let currentPage = 1;

    // Fetch data
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        allProducts = data.map(p => ({
          nama: p['Nama Produk'] || 'Tidak Diketahui',
          kategori: p['Kategori'] || 'Umum',
          harga: p['Harga'] || 0,
          deskripsi: p['Deskripsi'] || 'Deskripsi tidak tersedia.',
          gambar: p['Gambar (URL)'] || 'https://via.placeholder.com/600x400?text=No+Image'
        }));
        filteredProducts = [...allProducts];
        renderCategories();
        renderProducts();
        updateCartBadge();
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('product-grid').innerHTML = '<p class="text-center">Gagal memuat data.</p>';
      });

    // Render produk
    function renderProducts() {
      const grid = document.getElementById('product-grid');
      grid.innerHTML = '';
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      pageProducts.forEach((product, index) => {
        const card = document.createElement('div');
        card.className = 'col fade-in';
        card.style.animationDelay = `${index * 0.1}s`;
        card.innerHTML = `
          <div class="card product-card h-100">
            <a href="detail.html?nama=${encodeURIComponent(product.nama)}&kategori=${encodeURIComponent(product.kategori)}&harga=${encodeURIComponent(product.harga)}&deskripsi=${encodeURIComponent(product.deskripsi)}&gambar=${encodeURIComponent(product.gambar)}" class="text-decoration-none text-dark">
              <img src="${product.gambar}" class="card-img-top" alt="Gambar ${product.nama}" loading="lazy">
              <div class="card-body">
                <h5 class="card-title">${product.nama}</h5>
                <p class="card-text text-muted small">${product.kategori}</p>
                <p class="card-text text-danger fw-bold">Rp ${Number(product.harga).toLocaleString('id-ID')}</p>
              </div>
            </a>
            <div class="card-footer bg-transparent border-0 d-flex justify-content-center pt-0 pb-3">
              <button class="btn btn-danger add-to-cart-btn" data-product='${JSON.stringify(product)}'><i class="bi bi-cart-plus me-2"></i>Tambah</button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
      renderPagination();
      addCartListeners();
    }

    // Render pagination
    function renderPagination() {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = i;
          renderProducts();
        });
        pagination.appendChild(li);
      }
    }

    // Render kategori
    function renderCategories() {
      const categories = [...new Set(allProducts.map(p => p.kategori))];
      const menu = document.getElementById('category-menu');
      menu.innerHTML = '<li class="list-group-item list-group-item-action"><a href="#" class="text-decoration-none" data-kategori="all">Semua Kategori</a></li>';
      categories.forEach(cat => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.innerHTML = `<a href="#" class="text-decoration-none" data-kategori="${cat}">${cat}</a>`;
        li.addEventListener('click', (e) => {
          e.preventDefault();
          const selected = e.target.dataset.kategori;
          filteredProducts = selected === 'all' ? [...allProducts] : allProducts.filter(p => p.kategori === selected);
          currentPage = 1;
          renderProducts();
          bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
        });
        menu.appendChild(li);
      });
    }

    // Search
    document.getElementById('search-input-modal').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      filteredProducts = allProducts.filter(p => p.nama.toLowerCase().includes(query));
      currentPage = 1;
      renderProducts();
    });

    // Cart functions
    function getCart() {
      return JSON.parse(localStorage.getItem('cart') || '[]');
    }

    function saveCart(cart) {
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartBadge();
    }

    function updateCartBadge() {
      const cart = getCart();
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const badge = document.getElementById('cart-badge');
      badge.textContent = totalItems;
      badge.style.display = totalItems > 0 ? 'block' : 'none';
    }

    function addCartListeners() {
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const product = JSON.parse(e.currentTarget.dataset.product);
                addToCart(product);
            });
        });
    }

    function addToCart(product) {
        let cart = getCart();
        const existingItem = cart.find(item => item.nama === product.nama);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({...product, quantity: 1});
        }
        saveCart(cart);
        alert(`${product.nama} ditambahkan ke keranjang!`);
    }

    function removeFromCart(productName) {
        let cart = getCart();
        const itemIndex = cart.findIndex(item => item.nama === productName);
        if (itemIndex > -1) {
            cart.splice(itemIndex, 1);
            saveCart(cart);
            renderCart();
        }
    }

    function clearCart() {
        localStorage.removeItem('cart');
        updateCartBadge();
        renderCart();
    }

    function renderCart() {
      const cart = getCart();
      const list = document.getElementById('cart-list');
      list.innerHTML = '';
      let total = 0;
      let whatsappText = "Saya ingin memesan:\n";

      cart.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div class="d-flex align-items-center flex-grow-1">
            <img src="${item.gambar}" alt="${item.nama}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 10px;">
            <div class="flex-grow-1">
              <strong>${item.nama}</strong><br>
              <span class="text-muted small">Rp ${Number(item.harga).toLocaleString('id-ID')} x ${item.quantity}</span>
            </div>
          </div>
          <button class="btn btn-sm btn-danger remove-item" data-name="${item.nama}"><i class="bi bi-trash"></i></button>
        `;
        list.appendChild(li);
        total += Number(item.harga) * item.quantity;
        whatsappText += `- ${item.nama} (${item.quantity} pcs) - Rp ${Number(item.harga).toLocaleString('id-ID')}\n`;
      });
      
      whatsappText += `\nTotal: Rp ${total.toLocaleString('id-ID')}`;
      
      document.getElementById('cart-total').textContent = total.toLocaleString('id-ID');
      document.getElementById('checkout-btn').href = `https://wa.me/6283807602549?text=${encodeURIComponent(whatsappText)}`;
      
      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const productName = e.currentTarget.dataset.name;
          removeFromCart(productName);
        });
      });
    }

    document.getElementById('cart-btn').addEventListener('click', renderCart);
    document.getElementById('clear-cart').addEventListener('click', clearCart);
  </script>
</body>
</html>
